import { requireRole } from '../../../utils/rbac.js'; import { r } from '../../../utils/redis.js'; export default defineEventHandler(async(e)=>{ requireRole(e,'EDITOR'); const id=e.context.params.id; const b=await readBody(e); const pid=Number(b?.playlistId||0); if(!pid) throw createError({status:400}); const rawPl=await r().get('playlist:'+pid); if(!rawPl) throw createError({status:404}); const last=JSON.parse(await r().get('source:'+id+':last')||'[]'); const pl=JSON.parse(rawPl); const key=(c)=>c.name+'|'+c.url; const seen=new Set(pl.channels.map(key)); for(const ch of last){ const k=key(ch); if(!seen.has(k)){ pl.channels.push(ch); seen.add(k) } } await r().set('playlist:'+pid, JSON.stringify(pl)); return {ok:true} })
