import { requireRole } from '../../utils/rbac.js'; import child from 'node:child_process'; import path from 'node:path'; import fs from 'node:fs/promises'; export default defineEventHandler(async(e)=>{ requireRole(e,'EDITOR'); const cfg=useRuntimeConfig(); const b=await readBody(e); const rel=String(b?.path||'').replace(/(^\/+|\.\.)/g,''); if(!rel) throw createError({status:400}); const abs=path.posix.join(cfg.mediaRoot,'uploads/videos',rel); const dir=path.posix.dirname(abs); const base=path.posix.basename(abs).replace(/\.[^/.]+$/,''); const out=path.posix.join(dir, base+'.jpg'); await new Promise((res,rej)=>{ const p=child.spawn('ffmpeg',['-y','-ss','00:00:02','-i',abs,'-vframes','1','-qscale:v','4',out]); p.on('exit',c=>c===0?res():rej(new Error('ffmpeg '+c))) }); return {ok:true, thumb:'/uploads/videos/'+rel.replace(/\.[^/.]+$/,'')+'.jpg'} })
