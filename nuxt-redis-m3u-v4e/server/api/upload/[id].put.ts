import { requireRole } from '../../utils/rbac.js'; import fs from 'node:fs'; import fsp from 'node:fs/promises'; import path from 'node:path'; import { pipeline } from 'node:stream/promises'; export default defineEventHandler(async(e)=>{ requireRole(e,'EDITOR'); const cfg=useRuntimeConfig(); const id=e.context.params.id; const dir=path.posix.join(cfg.mediaRoot,'tmp_uploads',id); await fsp.mkdir(dir,{recursive:true}); const idx=Number(getHeader(e,'x-chunk-index')||'0'); const p=path.posix.join(dir, `${idx}.part`); const ws=fs.createWriteStream(p,{flags:'w'}); await pipeline(e.node.req, ws); return '' })
